// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© MarkTaylor
// Capital Flow Filter v4.5.0

//@version=6
indicator("Capital Flow Filter [v4.5.0]", shorttitle="Capital Flow", overlay=true, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

tradingModeInput = input.string("Auto", "Trading Mode", 
     options=["Auto", "Swing", "Intraday", "Scalp"], 
     group="Mode",
     tooltip="Auto: Detects chart timeframe automatically\nSwing: 4H/D/W data, slower signals\nIntraday: 15m/1H/4H data, faster signals\nScalp: 5m/15m/1H data, fastest signals")

// Auto-detect mode based on chart timeframe
// 1m-15m = Scalp | 30m-4H = Intraday | Daily+ = Swing
autoDetectedMode = timeframe.in_seconds() <= 900 ? "Scalp" : timeframe.in_seconds() <= 14400 ? "Intraday" : "Swing"

tradingMode = tradingModeInput == "Auto" ? autoDetectedMode : tradingModeInput

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - DATA SOURCES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

src_dxy = input.symbol("TVC:DXY", "DXY (Dollar Index)", group="Data Sources - Macro")
src_vix = input.symbol("TVC:VIX", "VIX (Volatility)", group="Data Sources - Macro")
src_gold = input.symbol("OANDA:XAUUSD", "Gold", group="Data Sources - Macro")
src_yields = input.symbol("TVC:US10Y", "US 10Y Yields", group="Data Sources - Macro")

src_btc = input.symbol("BINANCE:BTCUSDT", "BTC", group="Data Sources - Crypto")
src_eth = input.symbol("BINANCE:ETHUSDT", "ETH", group="Data Sources - Crypto")

src_btcd = input.symbol("CRYPTOCAP:BTC.D", "BTC Dominance", group="Data Sources - Sectors")
src_total3 = input.symbol("CRYPTOCAP:TOTAL3", "TOTAL3 (Alt Cap)", group="Data Sources - Sectors")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - KELTNER CLOUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

keltnerLength = input.int(20, "Keltner Length", minval=5, maxval=50, group="Cloud")
keltnerMult = input.float(2.0, "Keltner Multiplier", minval=0.5, maxval=5.0, step=0.1, group="Cloud")
showKeltner = input.bool(true, "Show Keltner Lines", group="Cloud")
cloudIntensity = input.float(1.0, "Cloud Intensity", minval=0.1, maxval=2.0, step=0.1, group="Cloud")
useThickness = input.bool(true, "Cloud Thickness = Conviction", group="Cloud")
useBgColor = input.bool(false, "Tint Chart Background", group="Cloud", tooltip="Subtle green/red background tint based on bias")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

flowLength = input.int(14, "Flow Calculation Length", minval=5, maxval=50, group="Settings")
lookbackMode = input.string("Auto", "Lookback Mode", options=["Auto", "Manual"], group="Settings",
     tooltip="Auto: Adjusts lookback based on mode & timeframe to maintain consistent time coverage\nManual: Use fixed lookback value")
lookbackManual = input.int(100, "Manual Lookback", minval=20, maxval=500, group="Settings")
showFlipDots = input.bool(true, "Show Flip Dots", group="Settings")
smoothingMode = input.string("Auto", "Smoothing", options=["Auto", "Manual"], group="Settings")
smoothingManual = input.int(5, "Manual Smoothing", minval=1, maxval=20, group="Settings")

// Performance tracking lookback
perfLookbackMode = input.string("Auto", "Performance Lookback", options=["Auto", "Last 20", "Last 50", "Last 100", "All Time"], group="Settings",
     tooltip="Auto: Scalp=20, Intraday=50, Swing=100 signals\nOr choose a fixed lookback for win rate calculation")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - SESSION FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

useSessionFilter = input.bool(false, "Enable Session Filter", group="Session", tooltip="Only for Intraday/Scalp modes")
sessionChoice = input.string("All", "Preferred Session", options=["All", "Asia", "London", "New York", "London+NY"], group="Session")
dimOutsideSession = input.bool(true, "Dim Signals Outside Session", group="Session")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

showTable = input.bool(true, "Show Panel", group="Panel")
tablePosition = input.string("Top Right", "Panel Position", 
     options=["Top Left", "Top Center", "Top Right", "Bottom Left", "Bottom Center", "Bottom Right"], 
     group="Panel")
tableSize = input.string("Normal", "Panel Size",
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group="Panel")
showExtendedInfo = input.bool(true, "Show Extended Info", group="Panel", tooltip="Confluence, momentum, time in state")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - PERSONALITY (The Fun Stuff)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

beastModeAlerts = input.bool(true, "ğŸ”¥ Beast Mode Alerts", group="Personality", 
     tooltip="John Carlton-style alerts that grab you by the throat and don't let go. Irreverent, fun, and impossible to ignore.")
showManipWarning = input.bool(true, "âš ï¸ Market Manipulation Warning", group="Personality",
     tooltip="Detects potential manipulation: volume anomalies, wick hunting, divergence spikes")
manipSensitivity = input.string("Normal", "Manipulation Sensitivity", options=["Relaxed", "Normal", "Paranoid"], group="Personality")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertStyle = input.string("Detailed", "Alert Message Style", options=["Simple", "Detailed", "Webhook"], group="Alerts")
alertCooldown = input.int(5, "Alert Cooldown (bars)", minval=1, maxval=50, group="Alerts", tooltip="Minimum bars between alerts")

// Score alerts
alertFullSend = input.bool(true, "Full Send Alerts (Â±70%)", group="Alerts - Score")
alertStandard = input.bool(true, "Standard Alerts (Â±50%)", group="Alerts - Score")
alertLean = input.bool(false, "Lean Alerts (Â±20%)", group="Alerts - Score")

// Flip alerts
alertFlip = input.bool(true, "Pressure Flip Alerts", group="Alerts - Flip")

// Confluence alerts
alertFullConfluence = input.bool(false, "Full Confluence (8/8)", group="Alerts - Confluence")
alertMacroAligned = input.bool(true, "Macro Aligned (4/4)", group="Alerts - Confluence")
alertCryptoLeaders = input.bool(false, "Crypto Leaders Aligned", group="Alerts - Confluence")

// Divergence alerts
alertDivergence = input.bool(false, "Divergence Alerts", group="Alerts - Advanced")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - VOLUME CANDLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

useVolumeCandles = input.bool(false, "Color Candles by Volume", group="Volume Candles")
volLookback = input.int(20, "Volume Lookback", minval=5, maxval=100, group="Volume Candles")
highVolThreshold = input.float(1.5, "High Volume Threshold", minval=1.1, maxval=3.0, step=0.1, group="Volume Candles")
veryHighVolThreshold = input.float(2.0, "Very High Volume Threshold", minval=1.5, maxval=5.0, step=0.1, group="Volume Candles")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bullish_strong = #00ffaa
bearish_strong = #ff4466
neutral_color = #888888
keltner_color = #ffcc00
accent_gold = #f0b90b
accent_blue = #3b82f6
accent_orange = #f59e0b
accent_red = #ef4444

bg_dark = color.new(#0d1117, 10)
bg_medium = color.new(#161b22, 10)
bg_light = color.new(#21262d, 10)
text_primary = #e6edf3
text_secondary = #8b949e
text_muted = #6e7681

vol_bull_very_high = #00bfff
vol_bull_high = #00d4aa
vol_bear_very_high = #ff00ff
vol_bear_high = #ff6b9d
vol_low = #4a4a4a
vol_normal_bull = #26a69a
vol_normal_bear = #ef5350

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

inAsia = (hour >= 0 and hour < 8)
inLondon = (hour >= 8 and hour < 16)
inNewYork = (hour >= 13 and hour < 21)
inLondonNY = inLondon or inNewYork

inPreferredSession = switch sessionChoice
    "All" => true
    "Asia" => inAsia
    "London" => inLondon
    "New York" => inNewYork
    "London+NY" => inLondonNY
    => true

sessionActive = not useSessionFilter or inPreferredSession
sessionMult = sessionActive ? 1.0 : (dimOutsideSession ? 0.5 : 1.0)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMEFRAME SELECTION BY MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

tf1 = switch tradingMode
    "Swing" => "240"
    "Intraday" => "15"
    "Scalp" => "5"
    => "240"

tf2 = switch tradingMode
    "Swing" => "1D"
    "Intraday" => "60"
    "Scalp" => "15"
    => "1D"

tf3 = switch tradingMode
    "Swing" => "1W"
    "Intraday" => "240"
    "Scalp" => "60"
    => "1W"

tf1_weight = 1.0
tf2_weight = 2.0
tf3_weight = 3.0
totalTfWeight = tf1_weight + tf2_weight + tf3_weight

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO LOOKBACK CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Scale lookback to maintain consistent time coverage across modes
// Swing: ~17 days coverage | Intraday: ~4 days | Scalp: ~2 days
// Also adjusts for chart timeframe within each mode

autoLookback = switch tradingMode
    "Swing" => timeframe.in_seconds() <= 3600 ? 200 :      // 1H or less: more bars needed
               timeframe.in_seconds() <= 14400 ? 100 :     // 4H: standard
               timeframe.in_seconds() <= 86400 ? 50 :      // Daily: fewer bars
               25                                           // Weekly+: minimal
    "Intraday" => timeframe.in_seconds() <= 900 ? 400 :    // 15m or less
                  timeframe.in_seconds() <= 3600 ? 200 :   // 1H
                  100                                       // 4H
    "Scalp" => timeframe.in_seconds() <= 300 ? 600 :       // 5m or less
               timeframe.in_seconds() <= 900 ? 400 :       // 15m
               200                                          // 1H
    => 100

lookback = lookbackMode == "Auto" ? autoLookback : lookbackManual

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO SMOOTHING CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

baseSmoothing = switch tradingMode
    "Swing" => timeframe.in_seconds() < 3600 ? 8 : timeframe.in_seconds() < 14400 ? 5 : timeframe.in_seconds() < 86400 ? 3 : 1
    "Intraday" => timeframe.in_seconds() < 900 ? 5 : timeframe.in_seconds() < 3600 ? 3 : 2
    "Scalp" => timeframe.in_seconds() < 300 ? 3 : 2
    => 3

smoothing = smoothingMode == "Auto" ? baseSmoothing : smoothingManual

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

getTablePosition() =>
    switch tablePosition
        "Top Left" => position.top_left
        "Top Center" => position.top_center
        "Top Right" => position.top_right
        "Bottom Left" => position.bottom_left
        "Bottom Center" => position.bottom_center
        "Bottom Right" => position.bottom_right
        => position.top_right

getTextSize(string baseSize) =>
    switch tableSize
        "Tiny" => size.tiny
        "Small" => baseSize == "normal" ? size.small : size.tiny
        "Normal" => baseSize == "normal" ? size.normal : size.small
        "Large" => baseSize == "normal" ? size.large : size.normal
        "Huge" => baseSize == "normal" ? size.huge : size.large
        => baseSize == "normal" ? size.normal : size.small

calcFlow(float src, int len) =>
    roc = ta.roc(src, len)
    ta.ema(roc, len)

getSignal(float flow, bool invert) =>
    threshold = 0.5
    rawSignal = flow > threshold ? 1.0 : flow < -threshold ? -1.0 : 0.0
    invert ? -rawSignal : rawSignal

calcCorrelation(float signal, int len) =>
    // Threshold for combined multi-TF signals (0.3 = need 30%+ agreement)
    // This filters out weak/conflicting signals that produce noisy correlation
    signalThreshold = 0.3

    priceUp = close > close[1]
    signalBull = signal > signalThreshold
    signalBear = signal < -signalThreshold
    signalActive = math.abs(signal) > signalThreshold

    correctBull = signalBull and priceUp ? 1.0 : 0.0
    correctBear = signalBear and not priceUp ? 1.0 : 0.0
    correct = correctBull + correctBear
    active = signalActive ? 1.0 : 0.0

    correctSum = math.sum(correct, len)
    activeSum = math.sum(active, len)

    activeSum > 10 ? (correctSum / activeSum) * 100 : 50.0

calcEdge(float corr) =>
    math.abs(corr - 50) / 50

calcMultiplier(float corr) =>
    corr >= 50 ? 1.0 : -1.0

calcWeight(float corr) =>
    0.2 + 0.8 * calcEdge(corr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASSET TYPE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

tickerUpper = str.upper(syminfo.ticker)
isBTC = str.contains(tickerUpper, "BTC") and not str.contains(tickerUpper, "BTC.D")
isETH = str.contains(tickerUpper, "ETH")
isMajor = isBTC or isETH
isAlt = not isMajor

macroMult = isBTC ? 1.2 : isETH ? 1.1 : 0.9
cryptoMult = isBTC ? 1.0 : isETH ? 1.1 : 1.0
sectorMult = isBTC ? 0.8 : isETH ? 1.0 : 1.3

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA RETRIEVAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MACRO
dxy_tf1 = request.security(src_dxy, tf1, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
dxy_tf2 = request.security(src_dxy, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
dxy_tf3 = request.security(src_dxy, tf3, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

vix_tf1 = request.security(src_vix, tf1, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
vix_tf2 = request.security(src_vix, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
vix_tf3 = request.security(src_vix, tf3, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

gold_tf1 = request.security(src_gold, tf1, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
gold_tf2 = request.security(src_gold, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
gold_tf3 = request.security(src_gold, tf3, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

yields_tf1 = request.security(src_yields, tf1, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
yields_tf2 = request.security(src_yields, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
yields_tf3 = request.security(src_yields, tf3, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

// CRYPTO
btc_tf1 = request.security(src_btc, tf1, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
btc_tf2 = request.security(src_btc, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
btc_tf3 = request.security(src_btc, tf3, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

eth_tf1 = request.security(src_eth, tf1, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
eth_tf2 = request.security(src_eth, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
eth_tf3 = request.security(src_eth, tf3, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

// SECTORS
btcd_tf2 = request.security(src_btcd, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)
total3_tf2 = request.security(src_total3, tf2, calcFlow(close, flowLength), lookahead=barmerge.lookahead_off)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MACRO - inverted (risk-off assets)
sig_dxy_1 = getSignal(dxy_tf1, true)
sig_dxy_2 = getSignal(dxy_tf2, true)
sig_dxy_3 = getSignal(dxy_tf3, true)

sig_vix_1 = getSignal(vix_tf1, true)
sig_vix_2 = getSignal(vix_tf2, true)
sig_vix_3 = getSignal(vix_tf3, true)

sig_gold_1 = getSignal(gold_tf1, true)
sig_gold_2 = getSignal(gold_tf2, true)
sig_gold_3 = getSignal(gold_tf3, true)

sig_yields_1 = getSignal(yields_tf1, true)
sig_yields_2 = getSignal(yields_tf2, true)
sig_yields_3 = getSignal(yields_tf3, true)

// CRYPTO - direct (risk-on assets)
sig_btc_1 = getSignal(btc_tf1, false)
sig_btc_2 = getSignal(btc_tf2, false)
sig_btc_3 = getSignal(btc_tf3, false)

sig_eth_1 = getSignal(eth_tf1, false)
sig_eth_2 = getSignal(eth_tf2, false)
sig_eth_3 = getSignal(eth_tf3, false)

// SECTORS
sig_btcd = getSignal(btcd_tf2, true)   // BTC.D up = alts down
sig_total3 = getSignal(total3_tf2, false)  // TOTAL3 up = alts up

// Combined multi-TF signals (weighted average)
sig_dxy = (sig_dxy_1 * tf1_weight + sig_dxy_2 * tf2_weight + sig_dxy_3 * tf3_weight) / totalTfWeight
sig_vix = (sig_vix_1 * tf1_weight + sig_vix_2 * tf2_weight + sig_vix_3 * tf3_weight) / totalTfWeight
sig_gold = (sig_gold_1 * tf1_weight + sig_gold_2 * tf2_weight + sig_gold_3 * tf3_weight) / totalTfWeight
sig_yields = (sig_yields_1 * tf1_weight + sig_yields_2 * tf2_weight + sig_yields_3 * tf3_weight) / totalTfWeight

sig_btc = (sig_btc_1 * tf1_weight + sig_btc_2 * tf2_weight + sig_btc_3 * tf3_weight) / totalTfWeight
sig_eth = (sig_eth_1 * tf1_weight + sig_eth_2 * tf2_weight + sig_eth_3 * tf3_weight) / totalTfWeight

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORRELATION & WEIGHTING (using auto/manual lookback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

corr_dxy = calcCorrelation(sig_dxy, lookback)
corr_vix = calcCorrelation(sig_vix, lookback)
corr_gold = calcCorrelation(sig_gold, lookback)
corr_yields = calcCorrelation(sig_yields, lookback)
corr_btc = calcCorrelation(sig_btc, lookback)
corr_eth = calcCorrelation(sig_eth, lookback)
corr_btcd = calcCorrelation(sig_btcd, lookback)
corr_total3 = calcCorrelation(sig_total3, lookback)

// Weights: 20% floor + 80% scaled by edge
w_dxy = calcWeight(corr_dxy)
w_vix = calcWeight(corr_vix)
w_gold = calcWeight(corr_gold)
w_yields = calcWeight(corr_yields)
w_btc = calcWeight(corr_btc)
w_eth = calcWeight(corr_eth)
w_btcd = calcWeight(corr_btcd)
w_total3 = calcWeight(corr_total3)

// Multipliers: flip contra-indicators
m_dxy = calcMultiplier(corr_dxy)
m_vix = calcMultiplier(corr_vix)
m_gold = calcMultiplier(corr_gold)
m_yields = calcMultiplier(corr_yields)
m_btc = calcMultiplier(corr_btc)
m_eth = calcMultiplier(corr_eth)
m_btcd = calcMultiplier(corr_btcd)
m_total3 = calcMultiplier(corr_total3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFLUENCE CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Effective signals (with multiplier applied)
eff_dxy = sig_dxy * m_dxy
eff_vix = sig_vix * m_vix
eff_gold = sig_gold * m_gold
eff_yields = sig_yields * m_yields
eff_btc = sig_btc * m_btc
eff_eth = sig_eth * m_eth
eff_btcd = sig_btcd * m_btcd
eff_total3 = sig_total3 * m_total3

// Count bullish/bearish signals
macroBull = (eff_dxy > 0 ? 1 : 0) + (eff_vix > 0 ? 1 : 0) + (eff_gold > 0 ? 1 : 0) + (eff_yields > 0 ? 1 : 0)
cryptoBull = (eff_btc > 0 ? 1 : 0) + (eff_eth > 0 ? 1 : 0)
sectorBull = (eff_btcd > 0 ? 1 : 0) + (eff_total3 > 0 ? 1 : 0)
bullCount = macroBull + cryptoBull + sectorBull

macroBear = (eff_dxy < 0 ? 1 : 0) + (eff_vix < 0 ? 1 : 0) + (eff_gold < 0 ? 1 : 0) + (eff_yields < 0 ? 1 : 0)
cryptoBear = (eff_btc < 0 ? 1 : 0) + (eff_eth < 0 ? 1 : 0)
sectorBear = (eff_btcd < 0 ? 1 : 0) + (eff_total3 < 0 ? 1 : 0)
bearCount = macroBear + cryptoBear + sectorBear

// Category confluence (using values computed above)
macroBullCount = macroBull
macroBearCount = macroBear
cryptoBullCount = cryptoBull
cryptoBearCount = cryptoBear
sectorBullCount = sectorBull
sectorBearCount = sectorBear

// Full alignment checks
fullBullConfluence = bullCount == 8
fullBearConfluence = bearCount == 8
macroAlignedBull = macroBullCount == 4
macroAlignedBear = macroBearCount == 4
cryptoLeadersBull = cryptoBullCount == 2
cryptoLeadersBear = cryptoBearCount == 2

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINAL SCORE CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

macroScore = (sig_dxy * m_dxy * w_dxy + sig_vix * m_vix * w_vix + 
              sig_gold * m_gold * w_gold + sig_yields * m_yields * w_yields) * macroMult
macroWeights = (w_dxy + w_vix + w_gold + w_yields) * macroMult

cryptoScore = (sig_btc * m_btc * w_btc + sig_eth * m_eth * w_eth) * cryptoMult
cryptoWeights = (w_btc + w_eth) * cryptoMult

sectorScore = (sig_btcd * m_btcd * w_btcd + sig_total3 * m_total3 * w_total3) * sectorMult
sectorWeights = (w_btcd + w_total3) * sectorMult

totalScore = macroScore + cryptoScore + sectorScore
totalWeights = macroWeights + cryptoWeights + sectorWeights

rawScore = totalWeights > 0.1 ? math.max(math.min(totalScore / totalWeights, 1.0), -1.0) : 0
rawScore := rawScore * sessionMult

// Apply smoothing
normalizedScore = smoothing > 1 ? ta.ema(rawScore, smoothing) : rawScore

// Score momentum
scoreMomentum = normalizedScore - normalizedScore[3]
strengthRising = scoreMomentum > 0.02

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIME IN STATE TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int barsInState = 0
var int lastStateDir = 0

currentStateDir = normalizedScore > 0.05 ? 1 : normalizedScore < -0.05 ? -1 : 0

if currentStateDir != lastStateDir
    barsInState := 1
    lastStateDir := currentStateDir
else
    barsInState += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIVERGENCE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

priceLowerLow = low < ta.lowest(low, 10)[1]
scoreHigherLow = normalizedScore > ta.lowest(normalizedScore, 10)[1] + 0.1
bullishDivergence = priceLowerLow and scoreHigherLow and normalizedScore < 0

priceHigherHigh = high > ta.highest(high, 10)[1]
scoreLowerHigh = normalizedScore < ta.highest(normalizedScore, 10)[1] - 0.1
bearishDivergence = priceHigherHigh and scoreLowerHigh and normalizedScore > 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOLATILITY WARNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

atrCurrent = ta.atr(14)
atrAvg = ta.sma(atrCurrent, 50)
highVolatility = atrCurrent > atrAvg * 1.5

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET MANIPULATION DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Sensitivity thresholds
manipVolMult = manipSensitivity == "Paranoid" ? 2.0 : manipSensitivity == "Normal" ? 2.5 : 3.0
manipWickMult = manipSensitivity == "Paranoid" ? 0.6 : manipSensitivity == "Normal" ? 0.7 : 0.8
manipFlashPct = manipSensitivity == "Paranoid" ? 0.015 : manipSensitivity == "Normal" ? 0.02 : 0.025

// Volume analysis
volAvg = ta.sma(volume, 20)
volSpike = volume > volAvg * manipVolMult
priceRange = math.abs(close - open)
avgRange = ta.sma(math.abs(close - open), 20)
tinyMove = priceRange < avgRange * 0.3

// 1. Accumulation/Distribution Warning: Huge volume, tiny price move
// Someone's loading up or dumping without moving price
accumDistWarning = volSpike and tinyMove

// 2. Wick Hunting / Stop Loss Raid
// Long wicks relative to body = someone's hunting stops
candleBody = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalWick = upperWick + lowerWick
wickHunting = candleBody > 0 and totalWick > candleBody * 3 and (upperWick > avgRange or lowerWick > avgRange)

// 3. Flash Crash/Pump Detection
// Sudden move followed by reversal
flashMove = math.abs(close - open[1]) / open[1] > manipFlashPct
reversal = (close > open and close[1] < open[1]) or (close < open and close[1] > open[1])
flashCrashPump = flashMove and reversal and volSpike

// 4. Spoofing Pattern: Price moved against volume direction
// Volume suggests one direction, price went the other way
volDirection = close > open ? 1 : close < open ? -1 : 0
prevVolDir = close[1] > open[1] ? 1 : close[1] < open[1] ? -1 : 0
spoofPattern = volSpike and volDirection != 0 and volDirection == -prevVolDir and math.abs(close - open) > avgRange * 1.5

// 5. Divergence Spike: Capital flow diverges sharply from price
// Market makers might be front-running
flowPriceDiv = (normalizedScore > 0.3 and close < open and priceRange > avgRange) or 
               (normalizedScore < -0.3 and close > open and priceRange > avgRange)

// Combined manipulation score (0-5)
manipScore = (accumDistWarning ? 1 : 0) + (wickHunting ? 1 : 0) + (flashCrashPump ? 1 : 0) + 
             (spoofPattern ? 1 : 0) + (flowPriceDiv ? 1 : 0)

// Manipulation warning levels
manipWarningLow = manipScore >= 1 and manipScore < 2
manipWarningMed = manipScore >= 2 and manipScore < 3
manipWarningHigh = manipScore >= 3

// Which type triggered?
manipType = accumDistWarning ? "ACCUMULATION" : wickHunting ? "WICK HUNT" : flashCrashPump ? "FLASH MOVE" : spoofPattern ? "SPOOF" : flowPriceDiv ? "FLOW DIVERGENCE" : "UNKNOWN"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KELTNER CHANNEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

keltnerBasis = ta.ema(close, keltnerLength)
keltnerAtr = ta.atr(keltnerLength)
keltnerUpper = keltnerBasis + keltnerAtr * keltnerMult
keltnerLower = keltnerBasis - keltnerAtr * keltnerMult

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOUD CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

strength = math.min(math.abs(normalizedScore), 1.0) * cloudIntensity
isBullish = normalizedScore > 0.05
isBearish = normalizedScore < -0.05

bullTransp = math.round(90 - strength * 50)
bearTransp = math.round(90 - strength * 50)

thicknessMult = useThickness ? 0.3 + strength * 0.7 : 1.0

// FIXED: Clouds now fill between basis and upper/lower bands only
// Bearish cloud = upper half of channel (basis to upper)
// Bullish cloud = lower half of channel (lower to basis)
// Thickness scales with conviction - higher conviction = thicker cloud

bearCloudTop = isBearish ? keltnerUpper : na
bearCloudBottom = isBearish ? keltnerUpper - (keltnerUpper - keltnerBasis) * thicknessMult : na

bullCloudTop = isBullish ? keltnerLower + (keltnerBasis - keltnerLower) * thicknessMult : na
bullCloudBottom = isBullish ? keltnerLower : na

keltnerLineColor = showKeltner ? color.new(keltner_color, 70) : color.new(color.white, 100)
basisLineColor = showKeltner ? color.new(keltner_color, 85) : color.new(color.white, 100)

pUpper = plot(keltnerUpper, "Keltner Upper", color=keltnerLineColor, linewidth=1)
pBasis = plot(keltnerBasis, "Keltner Basis", color=basisLineColor, linewidth=1, style=plot.style_linebr)
pLower = plot(keltnerLower, "Keltner Lower", color=keltnerLineColor, linewidth=1)

pBearTop = plot(bearCloudTop, "Bear Cloud Top", color=color.new(color.white, 100), display=display.none)
pBearBottom = plot(bearCloudBottom, "Bear Cloud Bottom", color=color.new(color.white, 100), display=display.none)
pBullTop = plot(bullCloudTop, "Bull Cloud Top", color=color.new(color.white, 100), display=display.none)
pBullBottom = plot(bullCloudBottom, "Bull Cloud Bottom", color=color.new(color.white, 100), display=display.none)

fill(pBearTop, pBearBottom, color=color.new(bearish_strong, bearTransp), title="Bearish Cloud")
fill(pBullTop, pBullBottom, color=color.new(bullish_strong, bullTransp), title="Bullish Cloud")

bgColor = useBgColor ? (normalizedScore > 0.1 ? color.new(bullish_strong, 95) : normalizedScore < -0.1 ? color.new(bearish_strong, 95) : na) : na
bgcolor(bgColor, title="Background Tint")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLIP DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

flipToBullish = normalizedScore > 0.05 and normalizedScore[1] <= 0.05
flipToBearish = normalizedScore < -0.05 and normalizedScore[1] >= -0.05

plotshape(showFlipDots and flipToBullish ? keltnerLower : na, "Bull Flip",
     shape.circle, location.absolute, bullish_strong, size=size.tiny)
plotshape(showFlipDots and flipToBearish ? keltnerUpper : na, "Bear Flip",
     shape.circle, location.absolute, bearish_strong, size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL PERFORMANCE TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Track signal outcomes for win rate display
// Determine performance lookback based on mode
perfLookbackLimit = switch perfLookbackMode
    "Auto" => tradingMode == "Scalp" ? 20 : tradingMode == "Intraday" ? 50 : 100
    "Last 20" => 20
    "Last 50" => 50
    "Last 100" => 100
    => 0  // All Time = 0 (no limit)

var int totalSignals = 0
var float lastSignalPrice = na
var int lastSignalDirection = 0  // 1 = bull, -1 = bear
var bool lastSignalCorrect = false
var bool hasLastSignal = false
var float lastSignalReturn = 0.0
var int currentStreak = 0

// Arrays to track rolling window of signal results
var array<bool> signalResults = array.new_bool(0)

// On each new flip signal, evaluate previous signal and record new one
if flipToBullish or flipToBearish
    // Evaluate previous signal if exists
    if not na(lastSignalPrice) and lastSignalDirection != 0
        priceChange = (close - lastSignalPrice) / lastSignalPrice * 100
        wasCorrect = (lastSignalDirection > 0 and priceChange > 0) or (lastSignalDirection < 0 and priceChange < 0)
        lastSignalCorrect := wasCorrect
        hasLastSignal := true
        lastSignalReturn := priceChange
        totalSignals := totalSignals + 1
        currentStreak := wasCorrect ? (currentStreak > 0 ? currentStreak + 1 : 1) : (currentStreak < 0 ? currentStreak - 1 : -1)

        // Add to rolling array
        array.push(signalResults, wasCorrect)

        // Trim array if we have a limit and exceeded it
        if perfLookbackLimit > 0 and array.size(signalResults) > perfLookbackLimit
            array.shift(signalResults)

    // Record new signal
    lastSignalPrice := close
    lastSignalDirection := flipToBullish ? 1 : -1

// Calculate win rate from array (rolling window)
arraySize = array.size(signalResults)
correctInWindow = 0
if arraySize > 0
    for i = 0 to arraySize - 1
        if array.get(signalResults, i)
            correctInWindow := correctInWindow + 1

winRate = arraySize > 0 ? (float(correctInWindow) / float(arraySize)) * 100 : na
displaySignalCount = arraySize

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOLUME CANDLE COLORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

avgVolume = ta.sma(volume, volLookback)
volRatio = volume / avgVolume

isBullCandle = close > open
isVeryHighVol = volRatio >= veryHighVolThreshold
isHighVol = volRatio >= highVolThreshold and not isVeryHighVol
isLowVol = volRatio < 0.5

getCandleColor() =>
    if not useVolumeCandles
        na
    else if isVeryHighVol
        isBullCandle ? vol_bull_very_high : vol_bear_very_high
    else if isHighVol
        isBullCandle ? vol_bull_high : vol_bear_high
    else if isLowVol
        vol_low
    else
        isBullCandle ? vol_normal_bull : vol_normal_bear

barcolor(getCandleColor(), title="Volume Candles")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT CONDITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var int lastAlertBar = 0
canAlert = bar_index - lastAlertBar >= alertCooldown

fullSendLong = normalizedScore > 0.7 and normalizedScore[1] <= 0.7 and canAlert
fullSendShort = normalizedScore < -0.7 and normalizedScore[1] >= -0.7 and canAlert
standardLong = normalizedScore > 0.5 and normalizedScore[1] <= 0.5 and canAlert
standardShort = normalizedScore < -0.5 and normalizedScore[1] >= -0.5 and canAlert
leanLong = normalizedScore > 0.2 and normalizedScore[1] <= 0.2 and canAlert
leanShort = normalizedScore < -0.2 and normalizedScore[1] >= -0.2 and canAlert

if fullSendLong or fullSendShort or standardLong or standardShort or leanLong or leanShort or flipToBullish or flipToBearish
    lastAlertBar := bar_index

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

scorePctStr = str.tostring(math.round(normalizedScore * 100))
currentDirection = normalizedScore > 0 ? "LONG" : "SHORT"
currentType = math.abs(normalizedScore) > 0.7 ? "FULL_SEND" : math.abs(normalizedScore) > 0.5 ? "STANDARD" : math.abs(normalizedScore) > 0.2 ? "LEAN" : "NEUTRAL"
confCount = normalizedScore > 0 ? bullCount : bearCount
macroCount = normalizedScore > 0 ? macroBullCount : macroBearCount
cryptoCount = normalizedScore > 0 ? cryptoBullCount : cryptoBearCount
sectorCount = normalizedScore > 0 ? sectorBullCount : sectorBearCount

simpleMsg = (normalizedScore > 0 ? "ğŸŸ¢ " : "ğŸ”´ ") + currentType + " " + scorePctStr + "% | " + syminfo.ticker

// Build webhook message in parts
wh1 = '{"action":"' + currentDirection + '","type":"' + currentType + '",'
wh2 = '"ticker":"' + syminfo.ticker + '","tf":"' + timeframe.period + '",'
wh3 = '"mode":"' + tradingMode + '","score":' + scorePctStr + ','
wh4 = '"confluence":' + str.tostring(confCount) + ',"macro":' + str.tostring(macroCount) + ','
wh5 = '"crypto":' + str.tostring(cryptoCount) + ',"sectors":' + str.tostring(sectorCount) + '}'
webhookMsg = wh1 + wh2 + wh3 + wh4 + wh5

// Build detailed message in parts
dt1 = (normalizedScore > 0 ? "ğŸŸ¢ " : "ğŸ”´ ") + currentType + " " + currentDirection
dt2 = " | " + syminfo.ticker + " " + timeframe.period + " | Score: " + scorePctStr + "%"
dt3 = " | Macro: " + str.tostring(macroCount) + "/4 | Crypto: " + str.tostring(cryptoCount) + "/2"
dt4 = " | Sectors: " + str.tostring(sectorCount) + "/2 | Confluence: " + str.tostring(confCount) + "/8"
detailedMsg = dt1 + dt2 + dt3 + dt4

alertMessage = switch alertStyle
    "Simple" => simpleMsg
    "Webhook" => webhookMsg
    "Detailed" => detailedMsg
    => detailedMsg

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT MESSAGES - BEAST MODE (John Carlton Style)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Beast Mode Messages - Full Send
beastFullLong = "ğŸš€ HOLY MOTHER OF GAINS! {{ticker}} just lit up like a Christmas tree on steroids. 8 signals screaming BUY. This is the setup you've been waiting for. Don't just sit there â€” MOVE!"
beastFullShort = "ğŸ”» RED ALERT! {{ticker}} is about to fall off a cliff and the smart money already has parachutes. 8 signals pointing DOWN. Get short or get rekt. Your choice."

// Beast Mode Messages - Standard
beastStdLong = "ğŸŸ¢ HEY! {{ticker}} is flashing green and the capital flow doesn't lie. This isn't a drill. Bulls are loading up while you're reading this."
beastStdShort = "ğŸ”´ INCOMING! {{ticker}} sellers just showed up with baseball bats. Capital is FLEEING. Don't be the last one holding the bag."

// Beast Mode Messages - Lean
beastLeanLong = "ğŸŸ¢ Psst... {{ticker}} is starting to look frisky. Not a full send yet, but the early birds are pecking. Worth a look."
beastLeanShort = "ğŸ”´ Hmm... {{ticker}} is getting a little wobbly. Nothing dramatic yet, but the cracks are showing. Stay frosty."

// Beast Mode Messages - Flips
beastFlipBull = "âš¡ PLOT TWIST! {{ticker}} just flipped BULLISH. The bears got caught napping. Pressure just shifted to the BUY side. Momentum is a freight train â€” don't stand on the tracks."
beastFlipBear = "âš¡ UH OH! {{ticker}} just flipped BEARISH. Bulls got the rug pulled. Money is rotating OUT. This could get ugly fast."

// Beast Mode Messages - Confluence
beastConfBull = "ğŸŒŸ JACKPOT! {{ticker}} - All 8 signals just aligned BULLISH. This is rarer than a honest politician. When everything agrees, you pay attention!"
beastConfBear = "ğŸ’€ DEFCON 1! {{ticker}} - All 8 signals screaming SELL. This isn't a warning â€” it's a GUARANTEE the smart money is heading for the exits."

// Beast Mode Messages - Macro
beastMacroBull = "ğŸŒ THE FED WHISPERER SAYS: DXY, VIX, Gold, Yields â€” they're ALL pointing to risk-on. Macro is giving crypto the green light. {{ticker}} has tailwinds."
beastMacroBear = "ğŸŒ MACRO STORM INCOMING! Every major indicator just went risk-off. DXY, VIX, the works. {{ticker}} is swimming against a tsunami."

// Beast Mode Messages - Crypto Leaders
beastLeadersBull = "â‚¿ THE KINGS HAVE SPOKEN! BTC and ETH both flipped bullish. When the big boys lead, alts follow. {{ticker}} is getting drafted."
beastLeadersBear = "â‚¿ ABANDON SHIP! BTC and ETH just went red. When mama and papa are sick, the kids don't feel so good either. {{ticker}} needs a miracle."

// Beast Mode Messages - Divergence
beastDivBull = "ğŸ”® HIDDEN GEM ALERT! {{ticker}} price is making lows but capital flow is secretly turning UP. Someone knows something. Classic accumulation pattern."
beastDivBear = "ğŸ”® TRAP DETECTED! {{ticker}} price making highs but capital is sneaking OUT the back door. Smart money is distributing to retail. Don't be retail."

// Beast Mode Messages - Manipulation Warning
beastManipWarn = "âš ï¸ MANIPULATION ALERT! {{ticker}} - Something fishy going on. "
beastManipAccum = "Huge volume, tiny price move = someone's loading up or dumping without moving price. Whales are hunting."
beastManipWick = "Wick hunting detected! Those long shadows aren't accidents â€” someone just raided your stop losses. Classic market maker games."
beastManipFlash = "Flash move + reversal = classic shakeout. They want your coins at discount prices. Don't fall for it."
beastManipSpoof = "Spoof pattern! Volume said one thing, price did another. Someone's playing 4D chess while you're playing checkers."
beastManipDiv = "Flow divergence! Capital flow and price are telling different stories. One of them is lying. Spoiler: it's usually price."

// Standard boring messages for non-beast mode
stdFullLong = "ğŸš€ FULL SEND LONG | {{ticker}} {{interval}} | Score: HIGH | Confluence: STRONG"
stdFullShort = "ğŸš€ FULL SEND SHORT | {{ticker}} {{interval}} | Score: HIGH | Confluence: STRONG"
stdStdLong = "ğŸŸ¢ STANDARD LONG | {{ticker}} {{interval}}"
stdStdShort = "ğŸ”´ STANDARD SHORT | {{ticker}} {{interval}}"
stdLeanLong = "ğŸŸ¢ LEAN LONG | {{ticker}} {{interval}}"
stdLeanShort = "ğŸ”´ LEAN SHORT | {{ticker}} {{interval}}"
stdFlipBull = "â†—ï¸ FLIP BULLISH | {{ticker}} {{interval}} | Pressure shifted to BUY side"
stdFlipBear = "â†˜ï¸ FLIP BEARISH | {{ticker}} {{interval}} | Pressure shifted to SELL side"
stdConfBull = "â­ FULL CONFLUENCE BULL | {{ticker}} | All 8 signals aligned BULLISH!"
stdConfBear = "â­ FULL CONFLUENCE BEAR | {{ticker}} | All 8 signals aligned BEARISH!"
stdMacroBull = "ğŸŒ MACRO ALIGNED BULL | {{ticker}} | All 4 macro signals support LONG"
stdMacroBear = "ğŸŒ MACRO ALIGNED BEAR | {{ticker}} | All 4 macro signals support SHORT"
stdLeadersBull = "â‚¿ CRYPTO LEADERS BULL | {{ticker}} | BTC + ETH both BULLISH"
stdLeadersBear = "â‚¿ CRYPTO LEADERS BEAR | {{ticker}} | BTC + ETH both BEARISH"
stdDivBull = "ğŸ“ˆ BULLISH DIVERGENCE | {{ticker}} {{interval}} | Price making lows but flow turning up"
stdDivBear = "ğŸ“‰ BEARISH DIVERGENCE | {{ticker}} {{interval}} | Price making highs but flow turning down"
stdManipWarn = "âš ï¸ MANIPULATION WARNING | {{ticker}} | Unusual market activity detected"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MASTER ALERT - ANY SIGNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Combine all alert conditions
anyFullSend = alertFullSend and (fullSendLong or fullSendShort)
anyStandard = alertStandard and (standardLong or standardShort)
anyLean = alertLean and (leanLong or leanShort)
anyFlip = alertFlip and (flipToBullish or flipToBearish) and canAlert
anyConfluence = alertFullConfluence and (fullBullConfluence or fullBearConfluence) and canAlert
anyMacro = alertMacroAligned and ((macroAlignedBull and not macroAlignedBull[1]) or (macroAlignedBear and not macroAlignedBear[1])) and canAlert
anyLeaders = alertCryptoLeaders and ((cryptoLeadersBull and not cryptoLeadersBull[1]) or (cryptoLeadersBear and not cryptoLeadersBear[1])) and canAlert
anyDivergence = alertDivergence and (bullishDivergence or bearishDivergence) and canAlert
anyManip = showManipWarning and (manipWarningHigh or manipWarningMed)

// Master trigger
anyAlert = anyFullSend or anyStandard or anyLean or anyFlip or anyConfluence or anyMacro or anyLeaders or anyDivergence or anyManip

// Build dynamic message for webhook/Telegram
alertType = anyFullSend ? (fullSendLong ? "ğŸš€ FULL SEND LONG" : "ğŸ”» FULL SEND SHORT") : anyStandard ? (standardLong ? "ğŸŸ¢ STANDARD LONG" : "ğŸ”´ STANDARD SHORT") : anyLean ? (leanLong ? "ğŸŸ¢ LEAN LONG" : "ğŸ”´ LEAN SHORT") : anyFlip ? (flipToBullish ? "â†—ï¸ FLIP BULLISH" : "â†˜ï¸ FLIP BEARISH") : anyConfluence ? (fullBullConfluence ? "â­ FULL CONFLUENCE BULL" : "â­ FULL CONFLUENCE BEAR") : anyMacro ? (macroAlignedBull ? "ğŸŒ MACRO BULL" : "ğŸŒ MACRO BEAR") : anyLeaders ? (cryptoLeadersBull ? "â‚¿ LEADERS BULL" : "â‚¿ LEADERS BEAR") : anyDivergence ? (bullishDivergence ? "ğŸ“ˆ BULL DIVERGENCE" : "ğŸ“‰ BEAR DIVERGENCE") : anyManip ? (manipWarningHigh ? "ğŸš¨ HIGH MANIPULATION" : "âš ï¸ MANIPULATION") : "ğŸ“Š SIGNAL"

// Dynamic message with all key info
dynamicMsg = alertType + " | " + syminfo.ticker + " " + timeframe.period + " | Score: " + scorePctStr + "% | Bulls: " + str.tostring(bullCount) + " Bears: " + str.tostring(bearCount)

// Fire alert() for webhook with dynamic message
if anyAlert
    alert(dynamicMsg, alert.freq_once_per_bar_close)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT CONDITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âš¡ ANY ALERT - Master trigger for all signals
alertcondition(anyAlert, title="âš¡ ANY ALERT", message="{{ticker}} {{interval}} | Capital Flow Signal Triggered | Check chart for details")

// Score Alerts - Full Send
alertcondition(alertFullSend and fullSendLong and beastModeAlerts, title="ğŸš€ Full Send LONG (Beast)", message="ğŸš€ HOLY MOTHER OF GAINS! {{ticker}} just lit up like a Christmas tree on steroids. 8 signals screaming BUY. This is the setup you've been waiting for. Don't just sit there â€” MOVE!")
alertcondition(alertFullSend and fullSendShort and beastModeAlerts, title="ğŸš€ Full Send SHORT (Beast)", message="ğŸ”» RED ALERT! {{ticker}} is about to fall off a cliff and the smart money already has parachutes. 8 signals pointing DOWN. Get short or get rekt. Your choice.")
alertcondition(alertFullSend and fullSendLong and not beastModeAlerts, title="ğŸš€ Full Send LONG", message="ğŸš€ FULL SEND LONG | {{ticker}} {{interval}} | Score: HIGH | Confluence: STRONG")
alertcondition(alertFullSend and fullSendShort and not beastModeAlerts, title="ğŸš€ Full Send SHORT", message="ğŸš€ FULL SEND SHORT | {{ticker}} {{interval}} | Score: HIGH | Confluence: STRONG")

// Score Alerts - Standard
alertcondition(alertStandard and standardLong and beastModeAlerts, title="ğŸŸ¢ Standard LONG (Beast)", message="ğŸŸ¢ HEY! {{ticker}} is flashing green and the capital flow doesn't lie. This isn't a drill. Bulls are loading up while you're reading this.")
alertcondition(alertStandard and standardShort and beastModeAlerts, title="ğŸ”´ Standard SHORT (Beast)", message="ğŸ”´ INCOMING! {{ticker}} sellers just showed up with baseball bats. Capital is FLEEING. Don't be the last one holding the bag.")
alertcondition(alertStandard and standardLong and not beastModeAlerts, title="ğŸŸ¢ Standard LONG", message="ğŸŸ¢ STANDARD LONG | {{ticker}} {{interval}}")
alertcondition(alertStandard and standardShort and not beastModeAlerts, title="ğŸ”´ Standard SHORT", message="ğŸ”´ STANDARD SHORT | {{ticker}} {{interval}}")

// Score Alerts - Lean
alertcondition(alertLean and leanLong and beastModeAlerts, title="ğŸŸ¢ Lean LONG (Beast)", message="ğŸŸ¢ Psst... {{ticker}} is starting to look frisky. Not a full send yet, but the early birds are pecking. Worth a look.")
alertcondition(alertLean and leanShort and beastModeAlerts, title="ğŸ”´ Lean SHORT (Beast)", message="ğŸ”´ Hmm... {{ticker}} is getting a little wobbly. Nothing dramatic yet, but the cracks are showing. Stay frosty.")
alertcondition(alertLean and leanLong and not beastModeAlerts, title="ğŸŸ¢ Lean LONG", message="ğŸŸ¢ LEAN LONG | {{ticker}} {{interval}}")
alertcondition(alertLean and leanShort and not beastModeAlerts, title="ğŸ”´ Lean SHORT", message="ğŸ”´ LEAN SHORT | {{ticker}} {{interval}}")

// Flip Alerts
alertcondition(alertFlip and flipToBullish and canAlert and beastModeAlerts, title="â†—ï¸ Flip Bullish (Beast)", message="âš¡ PLOT TWIST! {{ticker}} just flipped BULLISH. The bears got caught napping. Pressure shifted to BUY side. Momentum is a freight train â€” don't stand on the tracks.")
alertcondition(alertFlip and flipToBearish and canAlert and beastModeAlerts, title="â†˜ï¸ Flip Bearish (Beast)", message="âš¡ UH OH! {{ticker}} just flipped BEARISH. Bulls got the rug pulled. Money is rotating OUT. This could get ugly fast.")
alertcondition(alertFlip and flipToBullish and canAlert and not beastModeAlerts, title="â†—ï¸ Flip Bullish", message="â†—ï¸ FLIP BULLISH | {{ticker}} {{interval}} | Pressure shifted to BUY side")
alertcondition(alertFlip and flipToBearish and canAlert and not beastModeAlerts, title="â†˜ï¸ Flip Bearish", message="â†˜ï¸ FLIP BEARISH | {{ticker}} {{interval}} | Pressure shifted to SELL side")

// Confluence Alerts
alertcondition(alertFullConfluence and fullBullConfluence and canAlert and beastModeAlerts, title="â­ Full Confluence BULL (Beast)", message="ğŸŒŸ JACKPOT! {{ticker}} - All 8 signals just aligned BULLISH. This is rarer than an honest politician. When everything agrees, you pay attention!")
alertcondition(alertFullConfluence and fullBearConfluence and canAlert and beastModeAlerts, title="â­ Full Confluence BEAR (Beast)", message="ğŸ’€ DEFCON 1! {{ticker}} - All 8 signals screaming SELL. This isn't a warning â€” it's a GUARANTEE the smart money is heading for the exits.")
alertcondition(alertFullConfluence and fullBullConfluence and canAlert and not beastModeAlerts, title="â­ Full Confluence BULL", message="â­ FULL CONFLUENCE BULL | {{ticker}} | All 8 signals aligned BULLISH!")
alertcondition(alertFullConfluence and fullBearConfluence and canAlert and not beastModeAlerts, title="â­ Full Confluence BEAR", message="â­ FULL CONFLUENCE BEAR | {{ticker}} | All 8 signals aligned BEARISH!")

// Macro Aligned Alerts
alertcondition(alertMacroAligned and macroAlignedBull and not macroAlignedBull[1] and canAlert and beastModeAlerts, title="ğŸŒ Macro BULL (Beast)", message="ğŸŒ THE FED WHISPERER SAYS: DXY, VIX, Gold, Yields â€” ALL pointing risk-on. Macro giving crypto the green light. {{ticker}} has tailwinds, baby!")
alertcondition(alertMacroAligned and macroAlignedBear and not macroAlignedBear[1] and canAlert and beastModeAlerts, title="ğŸŒ Macro BEAR (Beast)", message="ğŸŒ MACRO STORM! Every major indicator just went risk-off. DXY, VIX, the works. {{ticker}} swimming against a tsunami. Good luck with that.")
alertcondition(alertMacroAligned and macroAlignedBull and not macroAlignedBull[1] and canAlert and not beastModeAlerts, title="ğŸŒ Macro Aligned BULL", message="ğŸŒ MACRO ALIGNED BULL | {{ticker}} | All 4 macro signals support LONG")
alertcondition(alertMacroAligned and macroAlignedBear and not macroAlignedBear[1] and canAlert and not beastModeAlerts, title="ğŸŒ Macro Aligned BEAR", message="ğŸŒ MACRO ALIGNED BEAR | {{ticker}} | All 4 macro signals support SHORT")

// Crypto Leaders Alerts
alertcondition(alertCryptoLeaders and cryptoLeadersBull and not cryptoLeadersBull[1] and canAlert and beastModeAlerts, title="â‚¿ Leaders BULL (Beast)", message="â‚¿ THE KINGS HAVE SPOKEN! BTC and ETH both flipped bullish. When the big boys lead, alts follow. {{ticker}} is getting drafted into the army of gains!")
alertcondition(alertCryptoLeaders and cryptoLeadersBear and not cryptoLeadersBear[1] and canAlert and beastModeAlerts, title="â‚¿ Leaders BEAR (Beast)", message="â‚¿ ABANDON SHIP! BTC and ETH just went red. When mama and papa are sick, the kids don't feel good either. {{ticker}} needs a miracle now.")
alertcondition(alertCryptoLeaders and cryptoLeadersBull and not cryptoLeadersBull[1] and canAlert and not beastModeAlerts, title="â‚¿ Crypto Leaders BULL", message="â‚¿ CRYPTO LEADERS BULL | {{ticker}} | BTC + ETH both BULLISH")
alertcondition(alertCryptoLeaders and cryptoLeadersBear and not cryptoLeadersBear[1] and canAlert and not beastModeAlerts, title="â‚¿ Crypto Leaders BEAR", message="â‚¿ CRYPTO LEADERS BEAR | {{ticker}} | BTC + ETH both BEARISH")

// Divergence Alerts
alertcondition(alertDivergence and bullishDivergence and canAlert and beastModeAlerts, title="ğŸ“ˆ Bull Divergence (Beast)", message="ğŸ”® HIDDEN GEM! {{ticker}} price making lows but capital flow secretly turning UP. Someone knows something. Classic accumulation. Smart money loading while you hesitate.")
alertcondition(alertDivergence and bearishDivergence and canAlert and beastModeAlerts, title="ğŸ“‰ Bear Divergence (Beast)", message="ğŸ”® TRAP DETECTED! {{ticker}} price making highs but capital sneaking OUT the back door. Smart money distributing to retail. Don't. Be. Retail.")
alertcondition(alertDivergence and bullishDivergence and canAlert and not beastModeAlerts, title="ğŸ“ˆ Bullish Divergence", message="ğŸ“ˆ BULLISH DIVERGENCE | {{ticker}} {{interval}} | Price making lows but flow turning up")
alertcondition(alertDivergence and bearishDivergence and canAlert and not beastModeAlerts, title="ğŸ“‰ Bearish Divergence", message="ğŸ“‰ BEARISH DIVERGENCE | {{ticker}} {{interval}} | Price making highs but flow turning down")

// Manipulation Alerts
alertcondition(showManipWarning and manipWarningHigh and beastModeAlerts, title="ğŸš¨ Manipulation HIGH (Beast)", message="ğŸš¨ THEY'RE MESSING WITH YOU! {{ticker}} showing HEAVY manipulation. Wick hunts, volume games, the works. Market makers are playing 4D chess. Either sit out or trade the trap.")
alertcondition(showManipWarning and manipWarningMed and beastModeAlerts, title="âš ï¸ Manipulation MED (Beast)", message="âš ï¸ SOMETHING'S FISHY! {{ticker}} manipulation detected. Could be accumulation, distribution, or stop hunting. Whales are circling. Proceed with caution, friend.")
alertcondition(showManipWarning and accumDistWarning and beastModeAlerts, title="ğŸ‹ Whale Activity (Beast)", message="ğŸ‹ WHALE ALERT! {{ticker}} - Massive volume but price barely moved. Translation: Someone's loading up (or dumping) without tipping their hand. Follow the smart money or get eaten.")
alertcondition(showManipWarning and wickHunting and beastModeAlerts, title="ğŸ¯ Stop Hunt (Beast)", message="ğŸ¯ STOP HUNT DETECTED! {{ticker}} - Those long wicks? Not accidents. Someone just raided stop losses. Classic MM move. If you got stopped out, they wanted your coins.")
alertcondition(showManipWarning and manipWarningHigh and not beastModeAlerts, title="ğŸš¨ Manipulation Warning HIGH", message="ğŸš¨ HIGH MANIPULATION | {{ticker}} | Multiple manipulation signals detected")
alertcondition(showManipWarning and manipWarningMed and not beastModeAlerts, title="âš ï¸ Manipulation Warning MED", message="âš ï¸ MANIPULATION | {{ticker}} | Unusual market activity detected")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE - OPTION D: COLLAPSIBLE DESIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Helper: Convert bars to human-readable time
getBarsAsTime(int bars) =>
    tfSeconds = timeframe.in_seconds()
    totalMinutes = bars * tfSeconds / 60
    if totalMinutes < 60
        str.tostring(math.round(totalMinutes)) + "m"
    else if totalMinutes < 1440
        str.tostring(math.round(totalMinutes / 60, 1)) + "h"
    else
        str.tostring(math.round(totalMinutes / 1440, 1)) + "d"

// Helper: Get signal arrow with color context (no more â†»)
getArrow(float sig, float mult) =>
    eff = sig * mult
    eff > 0.3 ? "â–²" : eff < -0.3 ? "â–¼" : "â€¢"

// Helper: Build confidence bar (simpler)
getConfBar(float score) =>
    filled = math.round(math.abs(score) * 10)
    bar = ""
    for i = 1 to 10
        bar := bar + (i <= filled ? "â–ˆ" : "â–‘")
    bar

// Helper: Get accuracy icon based on correlation %
getAccuracyIcon(float corr) =>
    corr > 60 ? "âœ“" : corr < 40 ? "âœ—" : "~"

// Helper: Get streak text (e.g., "3W" or "2L")
getStreakText(int streak) =>
    math.abs(streak) < 2 ? "" : streak > 0 ? str.tostring(streak) + "W" : str.tostring(math.abs(streak)) + "L"

// Helper: Get last signal result text
getLastSignalText(bool hasSignal, bool correct, float returnPct) =>
    not hasSignal ? "â€”" : (correct ? "âœ“" : "âœ—") + (returnPct > 0 ? "+" : "") + str.tostring(returnPct, "#.#") + "%"

// Table size based on expanded/collapsed (extra row for manipulation warning + performance)
tableRows = showExtendedInfo ? 17 : 6
var table panel = table.new(getTablePosition(), 4, tableRows, bgcolor=bg_dark, border_width=0)

// Manipulation warning colors
manipBgColor = color.new(#ff6b35, 70)
manipTextColor = #ff6b35

getSignalColor(float sig, float mult) =>
    effectiveSig = sig * mult
    effectiveSig > 0 ? bullish_strong : effectiveSig < 0 ? bearish_strong : neutral_color

getVerdictBgColor(float score) =>
    score > 0.1 ? color.new(bullish_strong, 70) : score < -0.1 ? color.new(bearish_strong, 70) : color.new(neutral_color, 70)

if barstate.islast and showTable
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMON ELEMENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    modeColor = switch tradingMode
        "Swing" => accent_blue
        "Intraday" => accent_orange
        "Scalp" => accent_red
        => neutral_color
    
    modeDisplay = tradingModeInput == "Auto" ? tradingMode + " â“" : tradingMode
    
    // Calculate summary arrows for each category
    macroArrows = getArrow(sig_dxy, m_dxy) + getArrow(sig_vix, m_vix) + getArrow(sig_gold, m_gold) + getArrow(sig_yields, m_yields)
    cryptoArrows = getArrow(sig_btc, m_btc) + getArrow(sig_eth, m_eth)
    sectorArrows = getArrow(sig_btcd, m_btcd) + getArrow(sig_total3, m_total3)
    
    // Category colors based on alignment
    macroColor = macroBullCount >= 3 ? bullish_strong : macroBearCount >= 3 ? bearish_strong : neutral_color
    cryptoColor = cryptoBullCount == 2 ? bullish_strong : cryptoBearCount == 2 ? bearish_strong : neutral_color
    sectorColor = sectorBullCount == 2 ? bullish_strong : sectorBearCount == 2 ? bearish_strong : neutral_color
    
    // Verdict calculations
    displayScore = math.max(math.min(normalizedScore, 1.0), -1.0)
    verdictText = displayScore > 0.7 ? "FULL SEND" : displayScore > 0.5 ? "BULLISH" : displayScore > 0.2 ? "LEAN BULL" : displayScore < -0.7 ? "FULL SEND" : displayScore < -0.5 ? "BEARISH" : displayScore < -0.2 ? "LEAN BEAR" : "NEUTRAL"
    verdictColor = displayScore > 0.1 ? bullish_strong : displayScore < -0.1 ? bearish_strong : neutral_color
    verdictBgColor = getVerdictBgColor(displayScore)
    scorePct = str.tostring(math.round(displayScore * 100)) + "%"
    confBar = getConfBar(displayScore)
    
    if showExtendedInfo
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPANDED VIEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Row 0: Header
        table.cell(panel, 0, 0, "CAPITAL FLOW", text_color=accent_gold, text_size=getTextSize("normal"), bgcolor=bg_medium, text_halign=text.align_left)
        table.cell(panel, 1, 0, "", bgcolor=bg_medium)
        table.cell(panel, 2, 0, "", bgcolor=bg_medium)
        table.cell(panel, 3, 0, modeDisplay, text_color=modeColor, text_size=getTextSize("small"), bgcolor=bg_medium, text_halign=text.align_right)
        
        // Row 1: MACRO header
        macroSummary = str.tostring(macroBullCount > macroBearCount ? macroBullCount : macroBearCount) + "/4 aligned"
        table.cell(panel, 0, 1, "MACRO", text_color=text_primary, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_left)
        table.cell(panel, 1, 1, "", bgcolor=bg_light)
        table.cell(panel, 2, 1, "", bgcolor=bg_light)
        table.cell(panel, 3, 1, macroSummary, text_color=macroColor, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_right)
        
        // Row 2: Macro details - DXY & VIX
        dxyText = getAccuracyIcon(corr_dxy) + "DXY " + str.tostring(corr_dxy, "#") + "%"
        vixText = getAccuracyIcon(corr_vix) + "VIX " + str.tostring(corr_vix, "#") + "%"
        table.cell(panel, 0, 2, dxyText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 1, 2, getArrow(sig_dxy, m_dxy), text_color=getSignalColor(sig_dxy, m_dxy), text_size=getTextSize("normal"), bgcolor=bg_dark)
        table.cell(panel, 2, 2, vixText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 3, 2, getArrow(sig_vix, m_vix), text_color=getSignalColor(sig_vix, m_vix), text_size=getTextSize("normal"), bgcolor=bg_dark, text_halign=text.align_right)
        
        // Row 3: Macro details - GOLD & US10Y
        goldText = getAccuracyIcon(corr_gold) + "GOLD " + str.tostring(corr_gold, "#") + "%"
        yieldsText = getAccuracyIcon(corr_yields) + "US10Y " + str.tostring(corr_yields, "#") + "%"
        table.cell(panel, 0, 3, goldText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 1, 3, getArrow(sig_gold, m_gold), text_color=getSignalColor(sig_gold, m_gold), text_size=getTextSize("normal"), bgcolor=bg_dark)
        table.cell(panel, 2, 3, yieldsText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 3, 3, getArrow(sig_yields, m_yields), text_color=getSignalColor(sig_yields, m_yields), text_size=getTextSize("normal"), bgcolor=bg_dark, text_halign=text.align_right)
        
        // Row 4: CRYPTO header
        cryptoSummary = str.tostring(cryptoBullCount > cryptoBearCount ? cryptoBullCount : cryptoBearCount) + "/2 aligned"
        table.cell(panel, 0, 4, "CRYPTO", text_color=text_primary, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_left)
        table.cell(panel, 1, 4, "", bgcolor=bg_light)
        table.cell(panel, 2, 4, "", bgcolor=bg_light)
        table.cell(panel, 3, 4, cryptoSummary, text_color=cryptoColor, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_right)
        
        // Row 5: Crypto details - BTC & ETH
        btcText = getAccuracyIcon(corr_btc) + "BTC " + str.tostring(corr_btc, "#") + "%"
        ethText = getAccuracyIcon(corr_eth) + "ETH " + str.tostring(corr_eth, "#") + "%"
        table.cell(panel, 0, 5, btcText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 1, 5, getArrow(sig_btc, m_btc), text_color=getSignalColor(sig_btc, m_btc), text_size=getTextSize("normal"), bgcolor=bg_dark)
        table.cell(panel, 2, 5, ethText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 3, 5, getArrow(sig_eth, m_eth), text_color=getSignalColor(sig_eth, m_eth), text_size=getTextSize("normal"), bgcolor=bg_dark, text_halign=text.align_right)
        
        // Row 6: SECTORS header
        sectorSummary = str.tostring(sectorBullCount > sectorBearCount ? sectorBullCount : sectorBearCount) + "/2 aligned"
        table.cell(panel, 0, 6, "SECTORS", text_color=text_primary, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_left)
        table.cell(panel, 1, 6, "", bgcolor=bg_light)
        table.cell(panel, 2, 6, "", bgcolor=bg_light)
        table.cell(panel, 3, 6, sectorSummary, text_color=sectorColor, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_right)
        
        // Row 7: Sector details - BTC.D & TOTAL3
        btcdText = getAccuracyIcon(corr_btcd) + "BTC.D " + str.tostring(corr_btcd, "#") + "%"
        total3Text = getAccuracyIcon(corr_total3) + "TOTAL3 " + str.tostring(corr_total3, "#") + "%"
        table.cell(panel, 0, 7, btcdText, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 1, 7, getArrow(sig_btcd, m_btcd), text_color=getSignalColor(sig_btcd, m_btcd), text_size=getTextSize("normal"), bgcolor=bg_dark)
        table.cell(panel, 2, 7, total3Text, text_color=text_secondary, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 3, 7, getArrow(sig_total3, m_total3), text_color=getSignalColor(sig_total3, m_total3), text_size=getTextSize("normal"), bgcolor=bg_dark, text_halign=text.align_right)
        
        // Row 8: Divider
        table.cell(panel, 0, 8, "", bgcolor=bg_light)
        table.cell(panel, 1, 8, "", bgcolor=bg_light)
        table.cell(panel, 2, 8, "", bgcolor=bg_light)
        table.cell(panel, 3, 8, "", bgcolor=bg_light)
        
        // Row 9: Status - Confluence & Momentum
        confCount = bullCount > bearCount ? bullCount : bearCount
        confText = str.tostring(confCount) + "/8 signals"
        momentumText = scoreMomentum > 0.02 ? "â†— Rising" : scoreMomentum < -0.02 ? "â†˜ Falling" : "â†’ Steady"
        momentumColor = scoreMomentum > 0.02 ? bullish_strong : scoreMomentum < -0.02 ? bearish_strong : neutral_color
        table.cell(panel, 0, 9, confText, text_color=verdictColor, text_size=getTextSize("small"), bgcolor=bg_medium, text_halign=text.align_left)
        table.cell(panel, 1, 9, "", bgcolor=bg_medium)
        table.cell(panel, 2, 9, "", bgcolor=bg_medium)
        table.cell(panel, 3, 9, momentumText, text_color=momentumColor, text_size=getTextSize("small"), bgcolor=bg_medium, text_halign=text.align_right)
        
        // Row 10: Status - Duration & Volatility
        durationText = getBarsAsTime(barsInState) + " in state"
        volText = highVolatility ? "âš  High Vol" : ""
        volColor = highVolatility ? accent_orange : text_muted
        table.cell(panel, 0, 10, durationText, text_color=text_muted, text_size=getTextSize("small"), bgcolor=bg_medium, text_halign=text.align_left)
        table.cell(panel, 1, 10, "", bgcolor=bg_medium)
        table.cell(panel, 2, 10, "", bgcolor=bg_medium)
        table.cell(panel, 3, 10, volText, text_color=volColor, text_size=getTextSize("small"), bgcolor=bg_medium, text_halign=text.align_right)
        
        // Row 11: Performance Stats Header
        table.cell(panel, 0, 11, "PERFORMANCE", text_color=text_primary, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_left)
        table.cell(panel, 1, 11, "", bgcolor=bg_light)
        table.cell(panel, 2, 11, "", bgcolor=bg_light)
        perfWindowLabel = perfLookbackLimit > 0 ? "Last " + str.tostring(displaySignalCount) : str.tostring(displaySignalCount) + " signals"
        table.cell(panel, 3, 11, perfWindowLabel, text_color=text_muted, text_size=getTextSize("small"), bgcolor=bg_light, text_halign=text.align_right)

        // Row 12: Performance Stats Details
        perfLabel = displaySignalCount > 0 ? "Win Rate: " + str.tostring(winRate, "#") + "%" : "â€”"
        perfColor = na(winRate) ? text_muted : winRate > 55 ? bullish_strong : winRate < 45 ? bearish_strong : neutral_color
        lastSignalLabel = hasLastSignal ? "Last: " + getLastSignalText(hasLastSignal, lastSignalCorrect, lastSignalReturn) : "Last: â€”"
        streakLabel = currentStreak != 0 ? "Streak: " + getStreakText(currentStreak) : ""
        streakColor = currentStreak > 0 ? bullish_strong : currentStreak < 0 ? bearish_strong : text_muted
        table.cell(panel, 0, 12, perfLabel, text_color=perfColor, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 1, 12, "", bgcolor=bg_dark)
        table.cell(panel, 2, 12, lastSignalLabel, text_color=not hasLastSignal ? text_muted : lastSignalCorrect ? bullish_strong : bearish_strong, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_right)
        table.cell(panel, 3, 12, streakLabel, text_color=streakColor, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_right)
        
        // Row 13: Verdict
        verdictIcon = displayScore > 0.5 ? "ğŸš€" : displayScore > 0.1 ? "ğŸŸ¢" : displayScore < -0.5 ? "ğŸ”»" : displayScore < -0.1 ? "ğŸ”´" : "âšª"
        table.cell(panel, 0, 13, verdictIcon + " " + verdictText, text_color=verdictColor, text_size=getTextSize("normal"), bgcolor=verdictBgColor, text_halign=text.align_left)
        table.cell(panel, 1, 13, "", bgcolor=verdictBgColor)
        table.cell(panel, 2, 13, "", bgcolor=verdictBgColor)
        table.cell(panel, 3, 13, scorePct, text_color=verdictColor, text_size=getTextSize("normal"), bgcolor=verdictBgColor, text_halign=text.align_right)

        // Row 14: Confidence bar
        table.cell(panel, 0, 14, confBar, text_color=verdictColor, text_size=getTextSize("small"), bgcolor=verdictBgColor, text_halign=text.align_left)
        table.cell(panel, 1, 14, "", bgcolor=verdictBgColor)
        table.cell(panel, 2, 14, "", bgcolor=verdictBgColor)
        table.cell(panel, 3, 14, "Confidence", text_color=text_muted, text_size=getTextSize("small"), bgcolor=verdictBgColor, text_halign=text.align_right)

        // Row 15-16: Manipulation Warning (if active)
        if showManipWarning and manipScore > 0
            manipIcon = manipWarningHigh ? "ğŸš¨" : manipWarningMed ? "âš ï¸" : "ğŸ‘€"
            manipLevelText = manipWarningHigh ? "HIGH MANIPULATION" : manipWarningMed ? "MANIPULATION" : "SUSPICIOUS"
            manipDetailText = beastModeAlerts ? (accumDistWarning ? "Whales loading" : wickHunting ? "Stop hunt!" : flashCrashPump ? "Shakeout" : spoofPattern ? "Spoofing" : "Flow divergence") : manipType

            table.cell(panel, 0, 15, manipIcon + " " + manipLevelText, text_color=manipTextColor, text_size=getTextSize("small"), bgcolor=manipBgColor, text_halign=text.align_left)
            table.cell(panel, 1, 15, "", bgcolor=manipBgColor)
            table.cell(panel, 2, 15, "", bgcolor=manipBgColor)
            table.cell(panel, 3, 15, manipDetailText, text_color=manipTextColor, text_size=getTextSize("small"), bgcolor=manipBgColor, text_halign=text.align_right)

            // Beast mode extra commentary
            beastComment = beastModeAlerts ? (manipWarningHigh ? "They're hunting you!" : "Watch your back") : ""
            table.cell(panel, 0, 16, beastComment, text_color=text_muted, text_size=getTextSize("small"), bgcolor=manipBgColor, text_halign=text.align_left)
            table.cell(panel, 1, 16, "", bgcolor=manipBgColor)
            table.cell(panel, 2, 16, "", bgcolor=manipBgColor)
            table.cell(panel, 3, 16, "", bgcolor=manipBgColor)
        
    else
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // COLLAPSED VIEW (Clean & Minimal)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Row 0: Header
        table.cell(panel, 0, 0, "CAPITAL FLOW", text_color=accent_gold, text_size=getTextSize("normal"), bgcolor=bg_medium, text_halign=text.align_left)
        table.cell(panel, 1, 0, "", bgcolor=bg_medium)
        table.cell(panel, 2, 0, "", bgcolor=bg_medium)
        table.cell(panel, 3, 0, modeDisplay, text_color=modeColor, text_size=getTextSize("small"), bgcolor=bg_medium, text_halign=text.align_right)
        
        // Row 1: Summary signals
        macroSum = "M:" + macroArrows
        cryptoSum = "C:" + cryptoArrows
        sectorSum = "S:" + sectorArrows
        table.cell(panel, 0, 1, macroSum, text_color=macroColor, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_left)
        table.cell(panel, 1, 1, cryptoSum, text_color=cryptoColor, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_center)
        table.cell(panel, 2, 1, "", bgcolor=bg_dark)
        table.cell(panel, 3, 1, sectorSum, text_color=sectorColor, text_size=getTextSize("small"), bgcolor=bg_dark, text_halign=text.align_right)
        
        // Row 2: Verdict
        verdictIcon = displayScore > 0.5 ? "ğŸš€" : displayScore > 0.1 ? "ğŸŸ¢" : displayScore < -0.5 ? "ğŸ”»" : displayScore < -0.1 ? "ğŸ”´" : "âšª"
        table.cell(panel, 0, 2, verdictIcon + " " + verdictText, text_color=verdictColor, text_size=getTextSize("normal"), bgcolor=verdictBgColor, text_halign=text.align_left)
        table.cell(panel, 1, 2, "", bgcolor=verdictBgColor)
        table.cell(panel, 2, 2, "", bgcolor=verdictBgColor)
        table.cell(panel, 3, 2, scorePct, text_color=verdictColor, text_size=getTextSize("normal"), bgcolor=verdictBgColor, text_halign=text.align_right)
        
        // Row 3: Confidence bar
        table.cell(panel, 0, 3, confBar, text_color=verdictColor, text_size=getTextSize("small"), bgcolor=verdictBgColor, text_halign=text.align_left)
        table.cell(panel, 1, 3, "", bgcolor=verdictBgColor)
        table.cell(panel, 2, 3, "", bgcolor=verdictBgColor)
        table.cell(panel, 3, 3, "", bgcolor=verdictBgColor)
        
        // Row 4-5: Manipulation Warning (if active) - Collapsed view
        if showManipWarning and manipScore > 0
            manipIcon = manipWarningHigh ? "ğŸš¨" : manipWarningMed ? "âš ï¸" : "ğŸ‘€"
            manipShortText = manipWarningHigh ? "MANIPULATION!" : manipWarningMed ? "SUSPICIOUS" : "WATCH"
            manipTypeShort = beastModeAlerts ? (accumDistWarning ? "Whales!" : wickHunting ? "Stop hunt!" : flashCrashPump ? "Shakeout!" : spoofPattern ? "Spoof!" : "Divergence!") : manipType
            
            table.cell(panel, 0, 4, manipIcon + " " + manipShortText, text_color=manipTextColor, text_size=getTextSize("small"), bgcolor=manipBgColor, text_halign=text.align_left)
            table.cell(panel, 1, 4, "", bgcolor=manipBgColor)
            table.cell(panel, 2, 4, "", bgcolor=manipBgColor)
            table.cell(panel, 3, 4, manipTypeShort, text_color=manipTextColor, text_size=getTextSize("small"), bgcolor=manipBgColor, text_halign=text.align_right)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA EXPORTS - CRS INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Core Score
plot(normalizedScore, title="Score", display=display.none)
plot(strength, title="Strength", display=display.none)

// Capital Flow Index (0-100 scale for CRS)
// 50 = neutral, >60 = risk-on, <40 = risk-off
cfi = 50 + (normalizedScore * 50)
plot(cfi, title="CFI", display=display.none)

// Regime State: 1 = Risk-On, 0 = Neutral, -1 = Risk-Off
regime = cfi > 60 ? 1 : cfi < 40 ? -1 : 0
plot(regime, title="Regime", display=display.none)

// Confidence (0-100) - Based on confluence + signal strength
confidence = (math.max(bullCount, bearCount) / 8.0) * 100 * math.min(math.abs(normalizedScore) * 2, 1.0)
plot(confidence, title="Confidence", display=display.none)

// Sector Tilt: 1 = Majors favored, -1 = Alts favored, 0 = Neutral
sectorTilt = (sig_btcd * m_btcd) > 0.3 ? 1 : (sig_total3 * m_total3) > 0.3 ? -1 : 0
plot(sectorTilt, title="Sector Tilt", display=display.none)

// Confluence counts
plot(bullCount, title="Bull Count", display=display.none)
plot(bearCount, title="Bear Count", display=display.none)

// Mode as number: 1 = Scalp, 2 = Intraday, 3 = Swing
modeNum = tradingMode == "Scalp" ? 1 : tradingMode == "Intraday" ? 2 : 3
plot(modeNum, title="Mode", display=display.none)
